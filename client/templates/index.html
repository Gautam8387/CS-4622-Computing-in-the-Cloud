<!-- ./client/templates/index.html -->
{% extends "base.html" %}
{% block content %}
    <h1 class="mb-4 text-dark">Media Transcoding Service</h1>
    <p class="text-muted mb-4">Convert your media files to any format. Fast, secure, and reliable.</p>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- Transcoding Form Card -->
    <div class="card p-4 shadow-sm mb-4">
        {% if user %}
            <div class="d-flex justify-content-between align-items-center mb-3">
                <span>Welcome, <strong>{{ user.name or user.email }}</strong>!</span>
                <a href="{{ url_for('logout') }}" class="btn btn-sm btn-outline-danger">Sign Out</a>
            </div>
        {% else %}
            <div class="mb-3 text-center">
                <p class="text-muted mb-2">Sign in to start transcoding and see your job history.</p>
                <a href="{{ url_for('login', provider='google') }}" class="btn btn-primary me-2 mb-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-google me-1" viewBox="0 0 16 16">
                      <path d="M15.545 6.558a9.4 9.4 0 0 1 .139 1.626c0 2.434-.87 4.492-2.384 5.885h.002C11.978 15.292 10.158 16 8 16A8 8 0 1 1 8 0a7.7 7.7 0 0 1 5.352 2.082l-2.284 2.284A4.35 4.35 0 0 0 8 3.166c-2.087 0-3.86 1.408-4.492 3.304a4.8 4.8 0 0 0 0 3.063h.003c.635 1.893 2.405 3.301 4.492 3.301 1.078 0 2.004-.276 2.722-.764h-.003a3.7 3.7 0 0 0 1.599-2.431H8v-3.08z"/>
                    </svg> Sign In with Google
                </a>
                <a href="{{ url_for('login', provider='github') }}" class="btn btn-dark mb-2">
                     <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-github me-1" viewBox="0 0 16 16">
                       <path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27s1.36.09 2 .27c1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.01 8.01 0 0 0 16 8c0-4.42-3.58-8-8-8"/>
                    </svg> Sign In with GitHub
                </a>
            </div>
            <hr {% if user %}class="d-none"{% endif %}> <!-- Hide hr if user is logged in -->
        {% endif %}

        <!-- Conditionally render form if user is logged in OR standalone mode -->
        {% if user %}
            <form id="uploadForm" enctype="multipart/form-data">
                <!-- Hidden email field if user is logged in -->
                {% if user %}
                 <input type="hidden" id="email" name="email" value="{{ user.email }}">
                {% else %}
                 <!-- Show email field if not logged in (though ideally login is required) -->
                  <div class="mb-3">
                     <label for="email" class="form-label">Email (for download link)</label>
                     <input type="email" class="form-control" id="email" name="email" required>
                 </div>
                {% endif %}

                <div class="mb-3">
                    <label for="file" class="form-label">Select File</label>
                    <input type="file" class="form-control d-none" id="file" name="file" accept="video/*,audio/*" required>
                    <div id="dropZone" class="drop-zone mt-1">
                        <p class="mb-1">Drag & drop your file here</p>
                        <p class="mb-1 small text-muted">or click to select</p>
                    </div>
                </div>

                <div id="formatSelector" class="mb-3 d-none"> <!-- Initially hidden -->
                    <label for="output_format" class="form-label">Output Format</label>
                    <select class="form-select" id="output_format" name="output_format" required></select>
                </div>

                <div class="d-grid gap-2"> <!-- Full width button -->
                    <button type="submit" class="btn btn-outline-secondary btn-lg" id="submitBtn" disabled>Select File First</button>
                </div>
            </form>
            <div id="status" class="mt-3"></div> <!-- Status messages -->
        {% elif config.STANDALONE_MODE %}
             <p class="text-warning">Standalone mode active. Upload will be mocked.</p>
              <!-- Show form even if not logged in for standalone testing -->
              <form id="uploadForm" enctype="multipart/form-data">
                   <div class="mb-3">
                      <label for="email" class="form-label">Email (for download link)</label>
                      <input type="email" class="form-control" id="email" name="email" required value="test@example.com">
                  </div>
                  <div class="mb-3">
                      <label for="file" class="form-label">Select File</label>
                      <input type="file" class="form-control d-none" id="file" name="file" accept="video/*,audio/*" required>
                      <div id="dropZone" class="drop-zone mt-1">
                          <p class="mb-1">Drag & drop your file here</p>
                          <p class="mb-1 small text-muted">or click to select</p>
                      </div>
                  </div>
                  <div id="formatSelector" class="mb-3 d-none">
                      <label for="output_format" class="form-label">Output Format</label>
                      <select class="form-select" id="output_format" name="output_format" required></select>
                  </div>
                   <div class="d-grid gap-2">
                      <button type="submit" class="btn btn-outline-secondary btn-lg" id="submitBtn" disabled>Select File First</button>
                   </div>
              </form>
              <div id="status" class="mt-3"></div>
        {% endif %}
    </div><!-- End Transcoding Form Card -->

    <!-- Recent Jobs Card (only if user is logged in and jobs exist) -->
    {% if user and jobs %}
        <div class="card p-4 shadow-sm mt-4" id="recentJobsContainer">
            <h2 class="mb-3 text-dark">Recent Transcoding Jobs</h2>
            <div class="table-responsive">
                <table class="table table-bordered table-striped table-hover">
                     <thead class="table-light">
                        <tr>
                            <th>Filename</th>
                            <th>Input</th>
                            <th>Output</th>
                            <th>Status</th>
                            <th>Timestamp</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for job in jobs %}
                            <tr>
                                <td class="text-break">{{ job.filename | truncate(30, True) }}</td>
                                <td><span class="badge bg-light text-dark">{{ job.input_format or 'N/A' }}</span></td>
                                <td><span class="badge bg-light text-dark">{{ job.output_format or 'N/A' }}</span></td>
                                <td>
                                     {% set status_lower = job.status | lower %}
                                     {% if status_lower == 'completed' %}
                                         <span class="badge bg-success">Completed</span>
                                     {% elif status_lower == 'failed' %}
                                         <span class="badge bg-danger">Failed</span>
                                     {% elif status_lower == 'pending' %}
                                          <span class="badge bg-info text-dark">Pending</span>
                                     {% elif status_lower == 'processing' or status_lower == 'started' %}
                                           <span class="badge bg-primary">Processing</span>
                                     {% else %}
                                         <span class="badge bg-secondary">{{ job.status }}</span>
                                     {% endif %}
                                </td>
                                <td class="text-nowrap">{{ job.timestamp or 'N/A' }}</td>
                                <td class="text-center">
                                     {% if job.status | lower == 'completed' and job.download_url and job.download_url != '#' %}
                                         <a href="{{ job.download_url }}" class="btn btn-sm btn-outline-primary" title="Download {{ job.filename }}" target="_blank" download>
                                             <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-download" viewBox="0 0 16 16">
                                               <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/>
                                               <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708z"/>
                                             </svg>
                                         </a>
                                     {% else %}
                                          <button class="btn btn-sm btn-outline-secondary" disabled title="Download not available">
                                               <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-download" viewBox="0 0 16 16">
                                                 <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5"/>
                                                 <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708z"/>
                                               </svg>
                                          </button>
                                     {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div> <!-- End table responsive -->
        </div> <!-- End Recent Jobs Card -->
     {% elif user and not jobs %}
         <div class="card p-4 shadow-sm mt-4" id="recentJobsContainer">
             <h2 class="mb-3 text-dark">Recent Transcoding Jobs</h2>
             <p class="text-muted">No recent jobs found.</p>
         </div>
     {% endif %}
{% endblock %}